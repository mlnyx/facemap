<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Willis ì•ˆë©´ ê³„ì¸¡ë²•</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        width: 100%;
      }

      header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
      }

      h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .subtitle {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .mode-selector {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-bottom: 30px;
      }

      .mode-button {
        background: white;
        padding: 20px 40px;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        font-size: 1.2em;
        font-weight: bold;
        color: #667eea;
        border: 3px solid transparent;
      }

      .mode-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      }

      .mode-button.active {
        border-color: #667eea;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .mode-content {
        display: none;
      }

      .mode-content.active {
        display: block;
      }

      .upload-section {
        background: white;
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        text-align: center;
        margin-bottom: 20px;
      }

      .upload-area {
        border: 3px dashed #667eea;
        border-radius: 10px;
        padding: 60px;
        margin: 20px 0;
        cursor: pointer;
        transition: all 0.3s;
      }

      .upload-area:hover {
        background: #f8f9fa;
        border-color: #764ba2;
      }

      .upload-area.dragover {
        background: #e7f3ff;
        border-color: #667eea;
      }

      #file-input {
        display: none;
      }

      .upload-icon {
        font-size: 4em;
        margin-bottom: 10px;
      }

      .upload-text {
        font-size: 1.2em;
        color: #666;
      }

      .preview-container {
        display: none;
        margin-top: 20px;
      }

      .preview-image {
        max-width: 100%;
        max-height: 500px;
        border-radius: 10px;
        margin: 20px 0;
      }

      .analyze-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 40px;
        border: none;
        border-radius: 10px;
        font-size: 1.2em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
      }

      .analyze-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .analyze-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .camera-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        margin-bottom: 20px;
      }

      #video-stream {
        width: 100%;
        border-radius: 10px;
      }

      .results-panel {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        margin-top: 20px;
      }

      .results-panel h2 {
        margin-bottom: 20px;
        color: #333;
        font-size: 1.8em;
        text-align: center;
      }

      .metric {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid #667eea;
      }

      .metric-label {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 5px;
      }

      .metric-value {
        font-size: 1.8em;
        font-weight: bold;
        color: #333;
      }

      .status {
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        font-size: 1.3em;
        font-weight: bold;
        margin-top: 10px;
      }

      .status.normal {
        background: #d4edda;
        color: #155724;
        border: 2px solid #c3e6cb;
      }

      .status.below {
        background: #f8d7da;
        color: #721c24;
        border: 2px solid #f5c6cb;
      }

      .status.above {
        background: #fff3cd;
        color: #856404;
        border: 2px solid #ffeeba;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .loading.active {
        display: block;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .mode-selector {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Willis ì•ˆë©´ ê³„ì¸¡ë²•</h1>
        <p class="subtitle">ìˆ˜ì§ê³ ê²½ í‰ê°€ ì‹œìŠ¤í…œ</p>
      </header>

      <div class="mode-selector">
        <div class="mode-button active" onclick="switchMode('upload')">
          ì‚¬ì§„ ì—…ë¡œë“œ
        </div>
        <div class="mode-button" onclick="switchMode('camera')">
          ì‹¤ì‹œê°„ ì¹´ë©”ë¼
        </div>
      </div>

      <!-- ì‚¬ì§„ ì—…ë¡œë“œ ëª¨ë“œ -->
      <div id="upload-mode" class="mode-content active">
        <div class="upload-section">
          <h2>ì‚¬ì§„ ì—…ë¡œë“œí•˜ê¸°</h2>
          <div
            class="upload-area"
            onclick="document.getElementById('file-input').click()"
            ondragover="handleDragOver(event)"
            ondrop="handleDrop(event)"
            ondragleave="handleDragLeave(event)"
          >
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">
              í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”<br />
              <small>(JPG, PNG ì§€ì›)</small>
            </div>
          </div>
          <input
            type="file"
            id="file-input"
            accept="image/*"
            onchange="handleFileSelect(event)"
          />

          <div class="preview-container" id="preview-container">
            <img id="preview-image" class="preview-image" alt="ë¯¸ë¦¬ë³´ê¸°" />
            <br />
            <button class="analyze-button" onclick="analyzeUploadedImage()">
              ë¶„ì„í•˜ê¸°
            </button>
          </div>

          <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 10px">ë¶„ì„ ì¤‘...</p>
          </div>
        </div>

        <div class="results-panel" id="upload-results" style="display: none">
          <h2 id="result-title">ğŸ“Š ë¶„ì„ ê²°ê³¼</h2>

          <!-- ì •ë©´ ë¶„ì„ ê²°ê³¼ -->
          <div id="frontal-results" style="display: none">
            <div class="metric">
              <div class="metric-label">ë™ê³µ-êµ¬ì—´ ê±°ë¦¬</div>
              <div class="metric-value" id="upload-pupil-mouth">0 px</div>
            </div>
            <div class="metric">
              <div class="metric-label">ë¹„ì €ë¶€-í„±ë ê±°ë¦¬</div>
              <div class="metric-value" id="upload-nose-chin">0 px</div>
            </div>
            <div class="metric">
              <div class="metric-label">Willis ë¹„ìœ¨</div>
              <div class="metric-value" id="upload-ratio">0.000</div>
            </div>
            <div class="metric">
              <div class="metric-label">ì–¼êµ´ ëŒ€ì¹­ë„</div>
              <div class="metric-value" id="upload-symmetry">0%</div>
            </div>
          </div>

          <!-- ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ -->
          <div id="profile-results" style="display: none">
            <div class="metric">
              <div class="metric-label">ì¸¡ë©´ Willis ë¹„ìœ¨</div>
              <div class="metric-value" id="upload-lateral-ratio">0.000</div>
            </div>
            <div class="metric">
              <div class="metric-label">ì½”ë-í„±ë ê±°ë¦¬</div>
              <div class="metric-value" id="upload-profile-nose-chin">0 px</div>
            </div>
            <div class="metric">
              <div class="metric-label">ëˆˆ-í„±ë ê±°ë¦¬</div>
              <div class="metric-value" id="upload-eye-chin">0 px</div>
            </div>
            <div class="metric">
              <div class="metric-label">í„± ê°ë„ (ì°¸ê³ )</div>
              <div class="metric-value" id="upload-chin-angle">0Â°</div>
            </div>
            <div class="metric">
              <div class="metric-label">ìì—°ìŠ¤ëŸ¬ì›€</div>
              <div class="metric-value" id="upload-naturalness">-</div>
            </div>
          </div>

          <div class="status" id="upload-status">ëŒ€ê¸° ì¤‘...</div>
        </div>
      </div>

      <!-- ì‹¤ì‹œê°„ ì¹´ë©”ë¼ ëª¨ë“œ -->
      <div id="camera-mode" class="mode-content">
        <div
          class="camera-section"
          style="position: relative; display: inline-block"
        >
          <video
            id="video-stream"
            autoplay
            playsinline
            style="
              width: 100%;
              max-width: 640px;
              border-radius: 10px;
              display: block;
              transform: scaleX(-1);
            "
          ></video>
          <canvas
            id="overlay-canvas"
            style="
              position: absolute;
              top: 0;
              left: 0;
              pointer-events: none;
              transform: scaleX(-1);
            "
          ></canvas>
          <canvas id="capture-canvas" style="display: none"></canvas>
        </div>

        <div class="results-panel">
          <h2>ğŸ“Š ì‹¤ì‹œê°„ ì¸¡ì • ë°ì´í„°</h2>
          <div class="metric">
            <div class="metric-label">ë™ê³µ-êµ¬ì—´ ê±°ë¦¬</div>
            <div class="metric-value" id="camera-pupil-mouth">0 px</div>
          </div>
          <div class="metric">
            <div class="metric-label">ë¹„ì €ë¶€-í„±ë ê±°ë¦¬</div>
            <div class="metric-value" id="camera-nose-chin">0 px</div>
          </div>
          <div class="metric">
            <div class="metric-label">Willis ë¹„ìœ¨</div>
            <div class="metric-value" id="camera-ratio">0.000</div>
          </div>
          <div class="status" id="camera-status">ëŒ€ê¸° ì¤‘...</div>
        </div>
      </div>
    </div>

    <script>
      let currentMode = "upload";
      let cameraUpdateInterval = null;
      let selectedFile = null;
      let videoStream = null;
      let videoElement = null;
      let canvasElement = null;

      function switchMode(mode) {
        currentMode = mode;

        // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
        document.querySelectorAll(".mode-button").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        // ì½˜í…ì¸  í‘œì‹œ ì „í™˜
        document.querySelectorAll(".mode-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(mode + "-mode").classList.add("active");

        // ì¹´ë©”ë¼ ëª¨ë“œì¼ ë•Œë§Œ ë°ì´í„° ì—…ë°ì´íŠ¸
        if (mode === "camera") {
          startCamera();
        } else {
          stopCameraUpdate();
          stopCamera();
        }
      }

      async function startCamera() {
        try {
          videoElement = document.getElementById("video-stream");
          canvasElement = document.getElementById("capture-canvas");
          const overlayCanvas = document.getElementById("overlay-canvas");

          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user", width: 320, height: 240 },
          });

          videoStream = stream;
          videoElement.srcObject = stream;

          // ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ í›„ ì˜¤ë²„ë ˆì´ ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
          videoElement.addEventListener("loadedmetadata", () => {
            overlayCanvas.width = videoElement.videoWidth;
            overlayCanvas.height = videoElement.videoHeight;
          });

          document.getElementById("camera-status").textContent =
            "ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ";

          // 1ì´ˆë§ˆë‹¤ í”„ë ˆì„ ìº¡ì²˜ ë° ë¶„ì„
          startCameraUpdate();
        } catch (error) {
          console.error("ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜:", error);
          document.getElementById("camera-status").textContent =
            "ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: " + error.message;
        }
      }

      function stopCamera() {
        if (videoStream) {
          videoStream.getTracks().forEach((track) => track.stop());
          videoStream = null;
        }
        if (videoElement) {
          videoElement.srcObject = null;
        }
      }

      function captureFrame() {
        if (!videoElement || !canvasElement) return null;

        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;

        const ctx = canvasElement.getContext("2d");
        ctx.drawImage(videoElement, 0, 0);

        return canvasElement.toDataURL("image/jpeg", 0.3);
      }

      function startCameraUpdate() {
        if (cameraUpdateInterval) return;

        cameraUpdateInterval = setInterval(async () => {
          const frameData = captureFrame();
          if (!frameData) return;

          try {
            const response = await fetch("/analyze_frame", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ frame: frameData }),
            });

            const data = await response.json();

            if (data.error) {
              document.getElementById("camera-status").textContent = data.error;
              clearLandmarks(); // ì—ëŸ¬ ì‹œ ëœë“œë§ˆí¬ ì§€ìš°ê¸°
              return;
            }

            document.getElementById("camera-pupil-mouth").textContent =
              data.pupil_to_mouth + " px";
            document.getElementById("camera-nose-chin").textContent =
              data.nose_to_chin + " px";
            document.getElementById("camera-ratio").textContent = data.ratio;

            const statusElement = document.getElementById("camera-status");
            statusElement.textContent = "íŒì •: " + data.classification;

            statusElement.className = "status";
            if (data.classification === "ì •ìƒ") {
              statusElement.classList.add("normal");
            } else if (data.classification.includes("í‰ê·  ì´í•˜")) {
              statusElement.classList.add("below");
            } else if (data.classification.includes("í‰ê·  ì´ìƒ")) {
              statusElement.classList.add("above");
            }

            // ëœë“œë§ˆí¬ ê·¸ë¦¬ê¸°
            if (data.landmarks && data.all_landmarks) {
              drawLandmarks(data.landmarks, data.all_landmarks);
            }
          } catch (error) {
            console.error("ë¶„ì„ ì˜¤ë¥˜:", error);
          }
        }, 300); // ì‹¤ì‹œê°„ ì‘ë‹µ: 0.3ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
      }

      function stopCameraUpdate() {
        if (cameraUpdateInterval) {
          clearInterval(cameraUpdateInterval);
          cameraUpdateInterval = null;
        }
      }

      function clearLandmarks() {
        const overlayCanvas = document.getElementById("overlay-canvas");
        if (!overlayCanvas) return;
        const ctx = overlayCanvas.getContext("2d");
        ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        e.target.closest(".upload-area").classList.add("dragover");
      }

      function drawLandmarks(landmarks, allLandmarks) {
        const overlayCanvas = document.getElementById("overlay-canvas");
        if (!overlayCanvas) return;

        const ctx = overlayCanvas.getContext("2d");
        ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

        // ì„±ëŠ¥ ìµœì í™”: 468ê°œ ëœë“œë§ˆí¬ í‘œì‹œ ë¹„í™œì„±í™” (í•„ìš”ì‹œ ì£¼ì„ í•´ì œ)
        // if (allLandmarks && allLandmarks.length > 0) {
        //   ctx.fillStyle = "rgba(0, 255, 0, 0.5)";
        //   allLandmarks.forEach((pt) => {
        //     ctx.beginPath();
        //     ctx.arc(pt[0], pt[1], 1, 0, 2 * Math.PI);
        //     ctx.fill();
        //   });
        // }

        // Willis ì£¼ìš” ì  ê·¸ë¦¬ê¸° (í° ì )
        ctx.fillStyle = "rgb(255, 255, 0)";
        const points = [
          landmarks.pupil_center,
          landmarks.mouth_center,
          landmarks.nose_point,
          landmarks.chin_point,
          landmarks.left_pupil,
          landmarks.right_pupil,
        ];

        points.forEach((pt) => {
          ctx.beginPath();
          ctx.arc(pt[0], pt[1], 5, 0, 2 * Math.PI);
          ctx.fill();
        });

        // Willis ì¸¡ì •ì„  ê·¸ë¦¬ê¸°
        // ë™ê³µ-êµ¬ì—´ ì„  (ë¹¨ê°„ìƒ‰)
        ctx.strokeStyle = "rgb(255, 0, 0)";
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(landmarks.pupil_center[0], landmarks.pupil_center[1]);
        ctx.lineTo(landmarks.mouth_center[0], landmarks.mouth_center[1]);
        ctx.stroke();

        // ë¹„ì €ë¶€-í„±ë ì„  (ë¹¨ê°„ìƒ‰)
        ctx.strokeStyle = "rgb(0, 255, 0)";
        ctx.beginPath();
        ctx.moveTo(landmarks.nose_point[0], landmarks.nose_point[1]);
        ctx.lineTo(landmarks.chin_point[0], landmarks.chin_point[1]);
        ctx.stroke();
      }

      function handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        e.target.closest(".upload-area").classList.remove("dragover");
      }

      function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        e.target.closest(".upload-area").classList.remove("dragover");

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      }

      function handleFileSelect(e) {
        const files = e.target.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      }

      function handleFile(file) {
        if (!file.type.startsWith("image/")) {
          alert("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          return;
        }

        selectedFile = file;
        const reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById("preview-image").src = e.target.result;
          document.getElementById("preview-container").style.display = "block";
          document.getElementById("upload-results").style.display = "none";
        };
        reader.readAsDataURL(file);
      }

      function analyzeUploadedImage() {
        if (!selectedFile) {
          alert("íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
          return;
        }

        const formData = new FormData();
        formData.append("file", selectedFile);

        document.getElementById("loading").classList.add("active");
        document.getElementById("upload-results").style.display = "none";

        fetch("/analyze", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("loading").classList.remove("active");

            if (data.error) {
              alert("ë¶„ì„ ì‹¤íŒ¨: " + data.error);
              return;
            }

            // ê²°ê³¼ ì œëª© ì—…ë°ì´íŠ¸
            document.getElementById("result-title").textContent =
              "" + data.analysis_type;

            if (data.is_frontal) {
              // ì •ë©´ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
              document.getElementById("frontal-results").style.display =
                "block";
              document.getElementById("profile-results").style.display = "none";

              document.getElementById("upload-pupil-mouth").textContent =
                data.pupil_to_mouth + " px";
              document.getElementById("upload-nose-chin").textContent =
                data.nose_to_chin + " px";
              document.getElementById("upload-ratio").textContent = data.ratio;
              document.getElementById("upload-symmetry").textContent =
                data.symmetry + "%";

              const statusElement = document.getElementById("upload-status");
              statusElement.textContent = "íŒì •: " + data.classification;

              statusElement.className = "status";
              if (data.classification === "ì •ìƒ") {
                statusElement.classList.add("normal");
              } else if (data.classification.includes("í‰ê·  ì´í•˜")) {
                statusElement.classList.add("below");
              } else if (data.classification.includes("í‰ê·  ì´ìƒ")) {
                statusElement.classList.add("above");
              }
            } else {
              // ì¸¡ë©´ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
              document.getElementById("frontal-results").style.display = "none";
              document.getElementById("profile-results").style.display =
                "block";

              document.getElementById("upload-lateral-ratio").textContent =
                data.lateral_ratio;
              document.getElementById("upload-profile-nose-chin").textContent =
                data.nose_to_chin + " px";
              document.getElementById("upload-eye-chin").textContent =
                data.eye_to_chin + " px";
              document.getElementById("upload-chin-angle").textContent =
                data.chin_angle + "Â°";
              document.getElementById("upload-naturalness").textContent =
                data.naturalness;

              const statusElement = document.getElementById("upload-status");
              statusElement.textContent = "í‰ê°€: " + data.classification;

              statusElement.className = "status";
              if (data.naturalness === "ì–‘í˜¸") {
                statusElement.classList.add("normal");
              } else {
                statusElement.classList.add("below");
              }
            }

            document.getElementById("upload-results").style.display = "block";
          })
          .catch((error) => {
            document.getElementById("loading").classList.remove("active");
            alert("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error);
          });
      }
    </script>
  </body>
</html>
